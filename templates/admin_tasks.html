{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <!-- Stats Cards -->
  <div class="row mb-2">
    <div class="col-md-2 col-6 mb-2">
      <div class="card text-center shadow-sm"><div class="card-body"><h6>Total Tasks</h6><h3>{{ total_tasks }}</h3></div></div>
    </div>
    <div class="col-md-2 col-6 mb-2">
      <div class="card text-center shadow-sm"><div class="card-body"><h6>Pending</h6><h3>{{ pending }}</h3></div></div>
    </div>
    <div class="col-md-2 col-6 mb-2">
      <div class="card text-center shadow-sm"><div class="card-body"><h6>In Progress</h6><h3>{{ in_progress }}</h3></div></div>
    </div>
    <div class="col-md-2 col-6 mb-2">
      <div class="card text-center shadow-sm"><div class="card-body"><h6>Completed</h6><h3>{{ completed }}</h3></div></div>
    </div>
    <div class="col-md-2 col-6 mb-2">
      <div class="card text-center shadow-sm"><div class="card-body"><h6>Overdue</h6><h3>{{ overdue }}</h3></div></div>
    </div>
  </div>
  <!-- Button Row -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-end gap-2 flex-wrap">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTaskModal"><i class="bi bi-plus-circle"></i> Assign Task</button>
        <button class="btn btn-outline-primary" id="exportCSV"><i class="bi bi-download"></i> Export CSV</button>
        <button class="btn btn-outline-secondary" id="calendarView"><i class="bi bi-calendar3"></i> Calendar View</button>
        <button class="btn btn-outline-secondary d-none" id="tableView"><i class="bi bi-table"></i> Table View</button>
      </div>
    </div>
  </div>
  <!-- Filters and Search -->
  <div class="row mb-3 g-2" id="filtersRow">
    <div class="col-md-3">
      <input type="text" class="form-control" id="taskSearch" placeholder="Search tasks...">
    </div>
    <div class="col-md-3">
      <select class="form-select" id="statusFilter">
        <option value="">All Statuses</option>
        <option value="assigned">Pending</option>
        <option value="completed">In Progress</option>
        <option value="approved">Completed</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="devFilter">
        <option value="">All Developers</option>
        {% for dev in developers %}
        <option value="{{ dev.username }}">{{ dev.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input type="date" class="form-control" id="deadlineFilter">
    </div>
  </div>
  <!-- Task Table -->
  <form id="bulkForm">
  <div id="tableSection">
  <table class="table table-bordered table-hover align-middle">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>Title</th>
        <th>Description</th>
        <th>Assigned To</th>
        <th>Assign Date</th>
        <th>Deadline</th>
        <th>Price</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="taskTableBody">
      {% for task in tasks %}
      <tr data-title="{{ task.name|lower }}" data-desc="{{ task.description|lower }}" data-status="{{ task.status }}" data-dev="{{ task.assigned_to }}" data-deadline="{{ task.deadline }}" data-url="{% url 'delete_task' task.id %}" {% if task.status != 'approved' and task.deadline < today %}class="table-danger"{% endif %}>
        <td><input type="checkbox" name="taskSelect" value="{{ task.id }}"></td>
        <td>{{ task.name }}</td>
        <td>{{ task.description }}</td>
        <td>{{ task.assigned_to }}</td>
        <td>{{ task.assign_date|default:"-" }}</td>
        <td>{{ task.deadline }}</td>
        <td>{{ task.price }}</td>
        <td>
          {% if task.status == 'assigned' %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% elif task.status == 'completed' %}
            <span class="badge bg-info text-dark">In Progress</span>
          {% elif task.status == 'approved' %}
            <span class="badge bg-success">Completed</span>
          {% endif %}
          {% if task.status != 'approved' and task.deadline < today %}
            <span class="badge bg-danger">Overdue</span>
          {% endif %}
        </td>
        <td>
          <button type="button" class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#editTaskModal{{ task.id }}" title="Edit"><i class="bi bi-pencil-square"></i></button>
          <a href="{% url 'task_ics' task.id %}" class="btn btn-outline-secondary btn-sm" title="Add to Calendar"><i class="bi bi-calendar-plus"></i></a>
          <form method="POST" action="{% url 'delete_task' task_id=task.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this task?');">
            <button type="submit" class="btn btn-danger btn-sm" title="Delete"><i class="bi bi-trash"></i></button>
          </form>
          {% if task.status == 'completed' %}
            <form method="POST" action="{% url 'approve_task' task_id=task.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm" title="Approve"><i class="bi bi-check-circle"></i></button>
            </form>
          {% endif %}
          {% if task.status == 'approved' %}
            <!-- Feedback button moved outside forms -->
            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#feedbackModal{{ task.id }}" title="Feedback"><i class="bi bi-chat-dots"></i></button>
          {% endif %}
        </td>
      </tr>
      <!-- Edit Task Modal -->
      <div class="modal fade" id="editTaskModal{{ task.id }}" tabindex="-1" aria-labelledby="editTaskModalLabel{{ task.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{% url 'edit_task' task_id=task.id %}" enctype="multipart/form-data">
              <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel{{ task.id }}">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Task Title</label>
                  <input type="text" name="title" class="form-control" value="{{ task.name }}" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Description</label>
                  <textarea name="description" class="form-control" required>{{ task.description }}</textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Assign To</label>
                  <select name="assigned_to" class="form-select" required>
                    <option value="">Assign to...</option>
                    {% for dev in developers %}
                    <option value="{{ dev.username }}" {% if dev.username == task.assigned_to %}selected{% endif %}>{{ dev.username }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Assign Date</label>
                  <input type="date" name="assign_date" class="form-control" value="{{ task.assign_date|default:'' }}" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Deadline</label>
                  <input type="date" name="deadline" class="form-control" value="{{ task.deadline }}" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Price</label>
                  <input type="number" name="price" class="form-control" value="{{ task.price }}" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Attachments</label>
                  <input type="file" name="attachments" class="form-control" multiple>
                  <small class="text-muted">Allowed: pdf, images, doc, docx, zip, txt. Max 5MB each.</small>
                  {% if task.attachments and task.attachments|length > 0 %}
                    <div class="mt-2">
                      <b>Existing Attachments:</b>
                      <ul class="list-unstyled mb-0">
                        {% for file in task.attachments %}
                          <li>
                            <a href="{% static 'uploads/' %}{{ file }}" target="_blank">{{ file|cut:'_' }}</a>
                            <!-- Optionally, add a remove button here in the future -->
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-warning">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </tbody>
  </table>
  </div>
  <!-- Render all feedback modals after the table -->
  {% for task in tasks %}
    {% if task.status == 'approved' %}
      <div class="modal fade" id="feedbackModal{{ task.id }}" tabindex="-1" aria-labelledby="feedbackModalLabel{{ task.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{% url 'submit_feedback' task_id=task.id %}">
              <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel{{ task.id }}">Feedback for {{ task.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Rating</label>
                  <select name="rating" class="form-select" required>
                    <option value="">Select rating</option>
                    {% for i in "12345" %}
                      <option value="{{ forloop.counter }}" {% if task.rating == forloop.counter %}selected{% endif %}>{{ forloop.counter }} Star{% if forloop.counter > 1 %}s{% endif %}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Feedback</label>
                  <textarea name="feedback" class="form-control" rows="3" placeholder="Write feedback...">{{ task.feedback|default:'' }}</textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-info">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
  <!-- Calendar Section -->
  <div id="calendarSection" class="d-none">
    <div id="calendar"></div>
  </div>
  <!-- Bulk Actions -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-danger" type="button" id="deleteSelected">Delete Selected</button>
    <button class="btn btn-success" type="button" id="approveSelected">Approve Selected</button>
  </div>
  </form>
  <!-- Add Task Modal -->
  <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{% url 'assign_task' %}" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title" id="addTaskModalLabel">Assign Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Task Title</label>
              <input type="text" name="title" class="form-control" placeholder="Task Title" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control" placeholder="Task Description" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Assign To</label>
              <select name="assigned_to" class="form-select" required>
                <option value="">Assign to...</option>
                {% for dev in developers %}
                <option value="{{ dev.username }}">{{ dev.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Assign Date</label>
              <input type="date" name="assign_date" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Deadline</label>
              <input type="date" name="deadline" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Price</label>
              <input type="number" name="price" class="form-control" placeholder="Price" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Attachments</label>
              <input type="file" name="attachments" class="form-control" multiple>
              <small class="text-muted">Allowed: pdf, images, doc, docx, zip, txt. Max 5MB each.</small>
            </div>
            <div class="mb-3">
              <label for="timeline" class="form-label">Timeline</label>
              <input type="text" class="form-control" id="timeline" name="timeline" placeholder="e.g. 2 weeks">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Assign Task</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function updateCountdowns() {
  let overdue = false;
  document.querySelectorAll('.countdown').forEach(function(span) {
    const deadline = new Date(span.getAttribute('data-deadline'));
    const status = span.getAttribute('data-status');
    if (status === 'approved') {
      span.textContent = '—';
      return;
    }
    const now = new Date();
    const diff = deadline - now;
    if (diff > 0) {
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const mins = Math.floor((diff / (1000 * 60)) % 60);
      const secs = Math.floor((diff / 1000) % 60);
      span.textContent = `${days}d ${hours}h ${mins}m ${secs}s`;
      span.classList.remove('text-danger');
    } else {
      span.textContent = 'Overdue!';
      span.classList.add('text-danger');
      overdue = true;
    }
  });
  const alert = document.getElementById('overdueAlert');
  if (alert) alert.classList.toggle('d-none', !overdue);
}
// --- Search and filter functionality ---
const searchInput = document.getElementById('taskSearch');
const statusFilter = document.getElementById('statusFilter');
const devFilter = document.getElementById('devFilter');
const deadlineFilter = document.getElementById('deadlineFilter');
const tableBody = document.getElementById('taskTableBody');
function filterTasks() {
  const search = searchInput.value.toLowerCase();
  const status = statusFilter.value;
  const dev = devFilter.value;
  const deadline = deadlineFilter.value;
  for (const row of tableBody.rows) {
    const title = row.getAttribute('data-title');
    const desc = row.getAttribute('data-desc');
    const rowStatus = row.getAttribute('data-status');
    const rowDev = row.getAttribute('data-dev');
    const rowDeadline = row.getAttribute('data-deadline');
    let show = true;
    if (search && !(title.includes(search) || desc.includes(search))) show = false;
    if (status && rowStatus !== status) show = false;
    if (dev && rowDev !== dev) show = false;
    if (deadline && rowDeadline !== deadline) show = false;
    row.style.display = show ? '' : 'none';
  }
}
searchInput.addEventListener('input', filterTasks);
statusFilter.addEventListener('change', filterTasks);
devFilter.addEventListener('change', filterTasks);
deadlineFilter.addEventListener('change', filterTasks);
// Select all functionality
const selectAll = document.getElementById('selectAll');
selectAll.addEventListener('change', function() {
  for (const cb of document.getElementsByName('taskSelect')) {
    if (cb.offsetParent !== null) cb.checked = selectAll.checked;
  }
});
// Bulk delete
const deleteSelected = document.getElementById('deleteSelected');
deleteSelected.addEventListener('click', function() {
  if (confirm('Delete selected tasks?')) {
    let submitted = 0;
    let total = 0;
    for (const cb of document.getElementsByName('taskSelect')) {
      if (cb.checked && cb.offsetParent !== null) {
        total++;
        const row = cb.closest('tr');
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = row.getAttribute('data-url');
        // Add CSRF token
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = getCookie('csrftoken');
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
        submitted++;
      }
    }
    if (submitted > 0) {
      setTimeout(function() { window.location.reload(); }, 500);
    }
  }
});
// Bulk approve
const approveSelected = document.getElementById('approveSelected');
approveSelected.addEventListener('click', function() {
  if (confirm('Approve selected completed tasks?')) {
    let submitted = 0;
    for (const cb of document.getElementsByName('taskSelect')) {
      if (cb.checked && cb.offsetParent !== null) {
        // Only approve if status is completed
        const row = cb.closest('tr');
        if (row && row.getAttribute('data-status') === 'completed') {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/dashboard/approve_task/' + cb.value + '/';
          // Add CSRF token
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'csrfmiddlewaretoken';
          input.value = getCookie('csrftoken');
          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
          submitted++;
        }
      }
    }
    if (submitted > 0) {
      setTimeout(function() { window.location.reload(); }, 500);
    }
  }
});
window.onload = function() {
  updateCountdowns();
  filterTasks();
};
setInterval(updateCountdowns, 1000);
</script>
{% endblock %} 