{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <!-- Header with Profile and Welcome -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div class="d-flex align-items-center">
      <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=6c757d&color=fff" class="rounded-circle me-3" width="60" height="60" alt="Dev Avatar">
      <div>
        <h2 class="mb-0">Welcome, {{ user.username }}</h2>
        <small class="text-muted">Developer{% if user and user.specialization %} &mdash; {{ user.specialization }}{% endif %}</small>
      </div>
    </div>
  </div>
  <!-- Alerts -->
  {% if overdue_tasks and overdue_tasks|length > 0 %}
    <div class="alert alert-danger d-flex align-items-center" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>
        <b>Overdue Tasks:</b>
        {% for t in overdue_tasks %}
          <span class="badge bg-danger me-1">{{ t.title }} (Due: {{ t.deadline }})</span>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  {% if upcoming_tasks and upcoming_tasks|length > 0 %}
    <div class="alert alert-warning d-flex align-items-center" role="alert">
      <i class="bi bi-alarm-fill me-2"></i>
      <div>
        <b>Upcoming Deadlines:</b>
        {% for t in upcoming_tasks %}
          <span class="badge bg-warning text-dark me-1">{{ t.title }} (Due: {{ t.deadline }})</span>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  <!-- Stats Cards -->
  <div class="row mb-4 g-3">
    <div class="col-md-4 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">Total Assigned</h6>
          <h3>{{ tasks|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">In Progress</h6>
          <h3>{{ assigned_tasks_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">Completed</h6>
          <h3>{{ approved_tasks_count }}</h3>
        </div>
      </div>
    </div>
  </div>
  <!-- Tasks Table -->
  <h4 class="mt-4 mb-3">My Tasks</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Deadline</th>
          <th>Price</th>
          <th>Timeline</th>
          <th>Admin</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Action</th>
          <th>Attachments</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr>
          <td>{{ task.name }}</td>
          <td>{{ task.description }}</td>
          <td>{{ task.deadline }}</td>
          <td>{{ task.price }}</td>
          <td>{{ task.timeline }}</td>
          <td>{{ task.admin }}</td>
          <td>
            {% if task.status == 'assigned' %}
              <span class="badge bg-secondary">Assigned</span>
            {% elif task.status == 'completed' %}
              <span class="badge bg-warning text-dark">Pending Approval</span>
            {% elif task.status == 'approved' %}
              <span class="badge bg-success">Approved</span>
            {% endif %}
          </td>
          <td style="min-width:120px;">
            <div class="progress">
              {% if task.status == 'assigned' %}
                <div class="progress-bar bg-secondary" role="progressbar" style="width: 33%;">33%</div>
              {% elif task.status == 'completed' %}
                <div class="progress-bar bg-warning text-dark" role="progressbar" style="width: 66%;">66%</div>
              {% elif task.status == 'approved' %}
                <div class="progress-bar bg-success" role="progressbar" style="width: 100%;">100%</div>
              {% endif %}
            </div>
          </td>
          <td>
            {% if task.status == 'assigned' %}
              <form method="POST" action="{% url 'complete_task' task.id %}" style="display:inline;" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="attachments" class="form-control form-control-sm mb-1" multiple>
                <button type="submit" class="btn btn-primary btn-sm">Mark Complete</button>
              </form>
            {% elif task.status == 'completed' %}
              <span class="badge bg-warning">Pending Approval</span>
            {% elif task.status == 'approved' %}
              <span class="badge bg-success">Approved</span>
            {% endif %}
          </td>
          <td>
            {% if task.attachment %}
              <a href="{{ task.attachment.url }}" target="_blank" class="d-block text-truncate" style="max-width:120px;">{{ task.attachment.name|cut:'task_attachments/' }}</a>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %} 