{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar with developer list and unread badges -->
    <div class="col-md-3 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">Developers</div>
        <ul class="list-group list-group-flush" id="dev-list">
          {% for dev in developers %}
          <a href="{% url 'admin_chat' dev.username %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if dev.username == developer_username %}active{% endif %}" data-dev="{{ dev.username }}">
            <span>{{ dev.username }}</span>
            <span class="badge bg-danger rounded-pill ms-2" id="unread-badge-{{ dev.username }}" style="display:none;">0</span>
          </a>
          {% endfor %}
        </ul>
      </div>
    </div>
    <!-- Chat area -->
    <div class="col-md-9">
      <h3>Chat with {{ developer_username }}</h3>
      <div class="card mb-3" style="max-height: 400px; overflow-y: auto;" id="chat-box">
        <div class="card-body" id="messages-container">
          {% for msg in messages %}
            <div class="mb-2">
              <b>{% if msg.sender == 'admin' %}You{% else %}{{ developer_username }}{% endif %}:</b>
              <span>{{ msg.content }}</span>
              <small class="text-muted">({{ msg.timestamp|date:'Y-m-d H:i' }})</small>
            </div>
          {% empty %}
            <div class="text-muted">No messages yet.</div>
          {% endfor %}
        </div>
      </div>
      <form method="POST" class="d-flex" id="chat-form">
        {% csrf_token %}
        <input type="text" name="content" class="form-control me-2" placeholder="Type a message..." required autocomplete="off">
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
      <!-- Toast Notification -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="chatToast" class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              New message received!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
<script>
let lastMessageCount = {{ messages|length }};
function fetchMessages() {
  fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newMessages = doc.querySelector('#messages-container').innerHTML;
      const newCount = doc.querySelectorAll('#messages-container > div.mb-2').length;
      document.getElementById('messages-container').innerHTML = newMessages;
      if (newCount > lastMessageCount) {
        var toast = new bootstrap.Toast(document.getElementById('chatToast'));
        toast.show();
      }
      lastMessageCount = newCount;
      // Auto-scroll
      var chatBox = document.getElementById('chat-box');
      chatBox.scrollTop = chatBox.scrollHeight;
    });
}
setInterval(fetchMessages, 3000);
// Initial auto-scroll
window.onload = function() {
  var chatBox = document.getElementById('chat-box');
  chatBox.scrollTop = chatBox.scrollHeight;
};

// Poll unread counts for each developer
function pollSidebarUnreadBadges() {
  fetch('/chat/unread_count?all=1')
    .then(response => response.json())
    .then(data => {
      for (const [dev, count] of Object.entries(data.unread_counts || {})) {
        var badge = document.getElementById('unread-badge-' + dev);
        if (badge) {
          if (count > 0) {
            badge.style.display = 'inline-block';
            badge.textContent = count;
          } else {
            badge.style.display = 'none';
          }
        }
      }
    });
}
setInterval(pollSidebarUnreadBadges, 3000);
window.onload = function() {
  var chatBox = document.getElementById('chat-box');
  chatBox.scrollTop = chatBox.scrollHeight;
  pollSidebarUnreadBadges();
};
</script> 