{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h3>Chat with Admin</h3>
  <div class="card mb-3" style="max-height: 400px; overflow-y: auto;" id="chat-box">
    <div class="card-body" id="messages-container">
      {% for msg in messages %}
        <div class="mb-2">
          <b>{% if msg.sender == user.username %}You{% else %}Admin{% endif %}:</b>
          <span>{{ msg.content }}</span>
          <small class="text-muted">({{ msg.timestamp|date:'Y-m-d H:i' }})</small>
        </div>
      {% empty %}
        <div class="text-muted">No messages yet.</div>
      {% endfor %}
    </div>
  </div>
  <form method="POST" class="d-flex" id="chat-form">
    {% csrf_token %}
    <input type="text" name="content" class="form-control me-2" placeholder="Type a message..." required autocomplete="off">
    <button type="submit" class="btn btn-primary">Send</button>
  </form>
  <a href="{% url 'developer-dashboard' %}" class="btn btn-link mt-3">Back to Dashboard</a>
  <!-- Toast Notification -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="chatToast" class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          New message received!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
<script>
let lastMessageCount = {{ messages|length }};
function fetchMessages() {
  fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newMessages = doc.querySelector('#messages-container').innerHTML;
      const newCount = doc.querySelectorAll('#messages-container > div.mb-2').length;
      document.getElementById('messages-container').innerHTML = newMessages;
      if (newCount > lastMessageCount) {
        var toast = new bootstrap.Toast(document.getElementById('chatToast'));
        toast.show();
      }
      lastMessageCount = newCount;
      // Auto-scroll
      var chatBox = document.getElementById('chat-box');
      chatBox.scrollTop = chatBox.scrollHeight;
    });
}
setInterval(fetchMessages, 3000);
// Initial auto-scroll
window.onload = function() {
  var chatBox = document.getElementById('chat-box');
  chatBox.scrollTop = chatBox.scrollHeight;
};
</script> 