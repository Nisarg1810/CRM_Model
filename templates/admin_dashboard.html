{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <!-- Header with Title and Action Buttons -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h2 class="mb-0">Admin Dashboard</h2>
      <small class="text-muted">Welcome, {{ user.username }}</small>
    </div>
    <div class="d-flex gap-2 mt-3 mt-md-0">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDeveloperModal"><i class="bi bi-person-plus me-1"></i> Add Developer</button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignTaskModal"><i class="bi bi-clipboard-plus me-1"></i> Assign Task</button>
    </div>
  </div>
  <!-- Stats Cards -->
  <div class="row mb-4 g-3">
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">Total Developers</h6>
          <h3>{{ developers|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">Total Tasks</h6>
          <h3>{{ tasks|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">Pending Approvals</h6>
          <h3>{{ tasks|dictsort:'status'|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">Completed Tasks</h6>
          <h3>{{ tasks|dictsort:'status'|length }}</h3>
        </div>
      </div>
    </div>
  </div>
  <!-- Developers Section -->
  <h4 class="mt-4 mb-3">Developers</h4>
  <div class="row g-3">
    {% for dev in developers %}
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex align-items-center">
          <img src="https://ui-avatars.com/api/?name={{ dev.username }}&background=6c757d&color=fff" class="rounded-circle me-3" width="50" height="50" alt="Avatar">
          <div>
            <h5 class="card-title mb-1">{{ dev.username }}</h5>
            <p class="card-text mb-1"><b>ID:</b> {{ dev.id }}<br><b>Mobile:</b> {{ dev.mobile }}<br><b>Role:</b> {{ dev.role }}<br><b>Specialization:</b> {{ dev.specialization|default:'-' }}<br><b>Capacity:</b> {{ dev.capacity }}</p>
            <div class="mt-2 d-flex gap-2">
              <form method="POST" action="{% url 'delete_developer' dev.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
              <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editDeveloperModal{{ dev.id }}">Edit</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Developer Modal -->
    <div class="modal fade" id="editDeveloperModal{{ dev.id }}" tabindex="-1" aria-labelledby="editDeveloperModalLabel{{ dev.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" action="{% url 'edit_developer' dev.id %}">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="editDeveloperModalLabel{{ dev.id }}">Edit Developer</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <input type="text" name="username" class="form-control" value="{{ dev.username }}" required>
              </div>
              <div class="mb-2">
                <input type="password" name="password" class="form-control" value="{{ dev.password }}" required>
              </div>
              <div class="mb-2">
                <input type="text" name="mobile" class="form-control" value="{{ dev.mobile }}" required>
              </div>
              <div class="mb-2">
                <select name="role" class="form-select role-select" required onchange="toggleSpecialization(this, 'edit{{ dev.id }}')">
                  <option value="developer" {% if dev.role == 'developer' %}selected{% endif %}>Developer</option>
                  <option value="admin" {% if dev.role == 'admin' %}selected{% endif %}>Admin</option>
                </select>
              </div>
              <div class="mb-2 specialization-group-edit{{ dev.id }}" {% if dev.role != 'developer' %}style="display:none;"{% endif %}>
                <select name="specialization" class="form-select" {% if dev.role == 'developer' %}required{% endif %}>
                  <option value="">Select Specialization</option>
                  <option value="Python Developer" {% if dev.specialization == 'Python Developer' %}selected{% endif %}>Python Developer</option>
                  <option value="Java Developer" {% if dev.specialization == 'Java Developer' %}selected{% endif %}>Java Developer</option>
                  <option value="Frontend Developer" {% if dev.specialization == 'Frontend Developer' %}selected{% endif %}>Frontend Developer</option>
                  <option value="Backend Developer" {% if dev.specialization == 'Backend Developer' %}selected{% endif %}>Backend Developer</option>
                </select>
              </div>
              <div class="mb-2">
                <input type="text" name="capacity" class="form-control" value="{{ dev.capacity }}" placeholder="Capacity" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-warning">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <hr>
  <!-- All Tasks Section -->
  <h4 class="mt-4 mb-3">All Tasks</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Assigned To</th>
          <th>Deadline</th>
          <th>Price</th>
          <th>Timeline</th>
          <th>Status</th>
          <th>Action</th>
          <th>Attachments</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr id="task-{{ task.id }}">
          <td>{{ task.name }}</td>
          <td>{{ task.description }}</td>
          <td>{{ task.assigned_to }}</td>
          <td>{{ task.deadline }}</td>
          <td>{{ task.price }}</td>
          <td>{{ task.timeline }}</td>
          <td>
            {% if task.status == 'assigned' %}
              <span class="badge bg-secondary">Assigned</span>
            {% elif task.status == 'completed' %}
              <span class="badge bg-warning text-dark">Pending Approval</span>
            {% elif task.status == 'approved' %}
              <span class="badge bg-success">Approved</span>
            {% endif %}
          </td>
          <td>
            {% if task.status == 'completed' %}
              <form method="POST" action="{% url 'approve_task' task.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm">Approve</button>
              </form>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if task.attachment %}
              <a href="{{ task.attachment.url }}" target="_blank" class="d-block text-truncate" style="max-width:120px;">{{ task.attachment.name|cut:'task_attachments/' }}</a>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Modals for Add Developer and Assign Task (unchanged) -->
  <div class="modal fade" id="addDeveloperModal" tabindex="-1" aria-labelledby="addDeveloperModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{% url 'add_developer' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="addDeveloperModalLabel">Add Developer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <input type="text" name="username" class="form-control" placeholder="Username" required>
            </div>
            <div class="mb-2">
              <input type="password" name="password" class="form-control" placeholder="Password" required>
            </div>
            <div class="mb-2">
              <input type="text" name="mobile" class="form-control" placeholder="Mobile Number" required>
            </div>
            <div class="mb-2">
              <select name="role" class="form-select role-select" required onchange="toggleSpecialization(this, 'add')">
                <option value="developer">Developer</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="mb-2 specialization-group-add">
              <select name="specialization" class="form-select" required>
                <option value="">Select Specialization</option>
                <option value="Python Developer">Python Developer</option>
                <option value="Java Developer">Java Developer</option>
                <option value="Frontend Developer">Frontend Developer</option>
                <option value="Backend Developer">Backend Developer</option>
              </select>
            </div>
            <div class="mb-2">
              <input type="text" name="capacity" class="form-control" placeholder="Capacity" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Add Developer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Assign Task Modal -->
  <div class="modal fade" id="assignTaskModal" tabindex="-1" aria-labelledby="assignTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{% url 'assign_task' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="assignTaskModalLabel">Assign Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Task Title</label>
              <input type="text" name="title" class="form-control" placeholder="Task Title" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control" placeholder="Task Description" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Assign To</label>
              <select name="assigned_to" class="form-select" required>
                <option value="">Assign to...</option>
                {% for dev in developers %}
                  <option value="{{ dev.username }}">{{ dev.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Assign Date</label>
              <input type="date" name="assign_date" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Deadline</label>
              <input type="date" name="deadline" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Price</label>
              <input type="number" name="price" class="form-control" placeholder="Price" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Attachments</label>
              <input type="file" name="attachments" class="form-control" multiple>
              <small class="text-muted">Allowed: pdf, images, doc, docx, zip, txt. Max 5MB each.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Assign Task</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} 
<script>
function toggleSpecialization(select, suffix) {
  var val = select.value;
  var group = document.querySelector('.specialization-group-' + suffix);
  if (group) group.style.display = (val === 'developer') ? '' : 'none';
}
// On page load, hide specialization for admin in add modal
window.onload = function() {
  var addRole = document.querySelector('.role-select[name="role"]');
  if (addRole) toggleSpecialization(addRole, 'add');
};
</script> 